ALKIMI SLACK BOT ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SLACK WORKSPACE                         â”‚
â”‚                                                                 â”‚
â”‚  User Types:                                                    â”‚
â”‚  â€¢ "@alkimi-bot What's our P&L?"                               â”‚
â”‚  â€¢ "/alkimi sql SELECT * FROM trades"                          â”‚
â”‚  â€¢ "Show trades over $5K"                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SLACK SOCKET MODE                          â”‚
â”‚                  (WebSocket Connection)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘                        BOT_MAIN.PY                              â•‘
â•‘                      (Entry Point)                              â•‘
â•‘                                                                 â•‘
â•‘  â€¢ Load environment variables                                   â•‘
â•‘  â€¢ Validate configuration                                       â•‘
â•‘  â€¢ Create bot instance                                          â•‘
â•‘  â€¢ Start Socket Mode handler                                    â•‘
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
                                â”‚
                                â–¼
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘                      ALKIMI BOT                                 â•‘
â•‘                   (slack_bot.py)                                â•‘
â•‘                                                                 â•‘
â•‘  Event Handlers:                                                â•‘
â•‘  â”œâ”€ handle_mention()     - @bot mentions                        â•‘
â•‘  â”œâ”€ handle_dm()          - Direct messages                      â•‘
â•‘  â””â”€ handle_command()     - /alkimi commands                     â•‘
â•‘                                                                 â•‘
â•‘  Query Router:                                                  â•‘
â•‘  â””â”€ _route_query() â†’ Routes to specific handlers               â•‘
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
         â”‚              â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  P&L   â”‚    â”‚ Trades â”‚    â”‚  SQL   â”‚    â”‚Functionâ”‚
    â”‚ Query  â”‚    â”‚ Query  â”‚    â”‚ Query  â”‚    â”‚ Query  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚             â”‚             â”‚             â”‚
         â–¼             â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPONENT LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  QueryRouter     â”‚  â”‚  ClaudeClient    â”‚  â”‚  QueryEngine â”‚ â”‚
â”‚  â”‚ (query_router)   â”‚  â”‚  (prompts)       â”‚  â”‚ (query_eng.) â”‚ â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ Classify       â”‚  â”‚ â€¢ Generate SQL   â”‚  â”‚ â€¢ Execute    â”‚ â”‚
â”‚  â”‚   intent         â”‚  â”‚ â€¢ Generate Pythonâ”‚  â”‚   SQL        â”‚ â”‚
â”‚  â”‚ â€¢ Extract        â”‚  â”‚ â€¢ Answer queries â”‚  â”‚ â€¢ Validate   â”‚ â”‚
â”‚  â”‚   parameters     â”‚  â”‚                  â”‚  â”‚   query      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PythonExecutor   â”‚  â”‚ FunctionStore    â”‚  â”‚ PnLCalculatorâ”‚ â”‚
â”‚  â”‚ (python_exec.)   â”‚  â”‚ (func_store)     â”‚  â”‚ (pnl_config) â”‚ â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ Validate code  â”‚  â”‚ â€¢ Save functions â”‚  â”‚ â€¢ Calculate  â”‚ â”‚
â”‚  â”‚ â€¢ Execute Python â”‚  â”‚ â€¢ List functions â”‚  â”‚   P&L        â”‚ â”‚
â”‚  â”‚ â€¢ Sandbox        â”‚  â”‚ â€¢ Track usage    â”‚  â”‚ â€¢ OTC mgmt   â”‚ â”‚
â”‚  â”‚   environment    â”‚  â”‚                  â”‚  â”‚ â€¢ Cost basis â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ DataProvider     â”‚  â”‚ SlackFormatter   â”‚                    â”‚
â”‚  â”‚ (data_provider)  â”‚  â”‚ (formatters)     â”‚                    â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚                    â”‚
â”‚  â”‚ â€¢ Get trades     â”‚  â”‚ â€¢ Format P&L     â”‚                    â”‚
â”‚  â”‚ â€¢ Get balances   â”‚  â”‚ â€¢ Format tables  â”‚                    â”‚
â”‚  â”‚ â€¢ Get prices     â”‚  â”‚ â€¢ Format errors  â”‚                    â”‚
â”‚  â”‚ â€¢ Save history   â”‚  â”‚ â€¢ Format code    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚             â”‚             â”‚             â”‚
         â–¼             â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATA LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  SQLite DB   â”‚  â”‚  Snapshots   â”‚  â”‚  CoinGecko   â”‚         â”‚
â”‚  â”‚              â”‚  â”‚   (JSON)     â”‚  â”‚    API       â”‚         â”‚
â”‚  â”‚ â€¢ Trades     â”‚  â”‚              â”‚  â”‚              â”‚         â”‚
â”‚  â”‚ â€¢ Functions  â”‚  â”‚ â€¢ Daily      â”‚  â”‚ â€¢ Current    â”‚         â”‚
â”‚  â”‚ â€¢ History    â”‚  â”‚   balances   â”‚  â”‚   price      â”‚         â”‚
â”‚  â”‚ â€¢ Config     â”‚  â”‚              â”‚  â”‚              â”‚         â”‚
â”‚  â”‚ â€¢ OTC        â”‚  â”‚              â”‚  â”‚              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


MESSAGE FLOW EXAMPLE: "What's our P&L this month?"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. User â†’ Slack
   "What's our P&L this month?"

2. Slack â†’ Socket Mode â†’ AlkimiBot
   event = {
     "type": "app_mention",
     "text": "<@BOT> What's our P&L this month?",
     "user": "U123456"
   }

3. AlkimiBot â†’ handle_mention()
   â€¢ Strip bot mention
   â€¢ Extract: "What's our P&L this month?"

4. QueryRouter â†’ classify()
   â€¢ Text: "What's our P&L this month?"
   â€¢ Intent: QueryIntent.PNL_QUERY
   â€¢ Params: {
       time_range: (Nov 1, Nov 30),
       raw_query: "What's our P&L this month?"
     }

5. AlkimiBot â†’ _route_query()
   â€¢ Route to: _handle_pnl_query()

6. _handle_pnl_query() â†’ PnLCalculator
   â€¢ Calculate P&L for date range
   â€¢ Include OTC transactions
   â€¢ Use configured cost basis method

7. PnLCalculator â†’ DataProvider
   â€¢ Get all trades for period
   â€¢ Get current balances
   â€¢ Get current price

8. DataProvider â†’ SQLite + CoinGecko
   â€¢ Query trades from database
   â€¢ Get current price from API
   â€¢ Return data

9. PnLCalculator â†’ Calculate
   â€¢ Realized P&L (sells - cost basis)
   â€¢ Unrealized P&L (holdings * (current - avg cost))
   â€¢ Net P&L (realized + unrealized)

10. PnLCalculator â†’ Return PnLReport
    {
      realized_pnl: +12450.23,
      unrealized_pnl: -495628.80,
      net_pnl: -483178.57,
      by_exchange: {...},
      ...
    }

11. SlackFormatter â†’ format_pnl_report()
    â€¢ Convert to Slack Block Kit
    â€¢ Add emojis (ğŸ“Š ğŸ“ˆ ğŸ“‰)
    â€¢ Format currency (+$12,450.23)
    â€¢ Create sections

12. AlkimiBot â†’ say()
    blocks = [
      {"type": "header", "text": "ğŸ“Š P&L REPORT"},
      {"type": "section", "text": "ğŸ’° REALIZED P&L\n..."},
      ...
    ]

13. Slack â†’ Display
    User sees rich formatted message with:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ“Š P&L REPORT (Nov 1-30, 2025) â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ğŸ’° REALIZED P&L                 â”‚
    â”‚ Total: +$12,450.23              â”‚
    â”‚   â”œâ”€ MEXC: +$8,230.15           â”‚
    â”‚   â”œâ”€ Gate.io: +$3,120.08        â”‚
    â”‚   â””â”€ KuCoin: +$1,100.00         â”‚
    â”‚                                 â”‚
    â”‚ ğŸ“ˆ UNREALIZED P&L               â”‚
    â”‚ Holdings: 6,388,000 ALKIMI      â”‚
    â”‚ Unrealized: -$495,628.80        â”‚
    â”‚                                 â”‚
    â”‚ ğŸ¯ NET P&L: -$483,178.57        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


COMMAND EXAMPLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Natural Language:
  @alkimi-bot What's our P&L this month?
  @alkimi-bot Show trades over $5K yesterday
  @alkimi-bot Current ALKIMI balance
  @alkimi-bot Best performing exchange this week

SQL Queries:
  /alkimi sql SELECT * FROM trades LIMIT 10
  /alkimi sql SELECT exchange, COUNT(*) FROM trades GROUP BY exchange

Function Management:
  /alkimi create find whale trades over $10K
  /alkimi functions
  /alkimi run whale_detector

P&L & Config:
  /alkimi pnl
  /alkimi config
  /alkimi config cost-basis FIFO
  /alkimi otc list

Other:
  /alkimi history
  /alkimi help


SECURITY LAYERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Layer 1: Slack Authentication
  â€¢ User authenticated by Slack
  â€¢ Valid workspace membership
  â€¢ Bot permissions enforced

Layer 2: Query Validation
  â€¢ SQL: Only SELECT queries
  â€¢ Python: AST-based validation
  â€¢ Parameter extraction and sanitization

Layer 3: Code Sandboxing
  â€¢ Whitelist of safe Python modules
  â€¢ No file system access
  â€¢ No network access
  â€¢ No subprocess execution

Layer 4: Database Access
  â€¢ Read-only connections
  â€¢ Parameterized queries
  â€¢ No DDL operations

Layer 5: Logging & Audit
  â€¢ All queries logged
  â€¢ User tracking
  â€¢ Error tracking
  â€¢ Performance monitoring
